<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Admin Panel - Order Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        /* Glassmorphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .glass-dark {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Custom Scrollbar for Table */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Smooth hover lift */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        /* Card shine effect */
        .shine-effect {
            position: relative;
            overflow: hidden;
        }
        
        .shine-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .shine-effect:hover::before {
            left: 100%;
        }
        
        /* Floating animation */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .float-animate {
            animation: float 3s ease-in-out infinite;
        }
        
        /* Pulse glow */
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 0 40px rgba(102, 126, 234, 0.8);
            }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }
        
        /* Fade in animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        /* Modal animations */
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-slide-in {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        /* Button glow effect */
        .btn-glow {
            position: relative;
            z-index: 1;
        }
        
        .btn-glow::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            background: linear-gradient(45deg, #667eea, #764ba2);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn-glow:hover::before {
            opacity: 0.2;
        }

        /* MODAL OVERLAY */
        .modal-overlay-bg {
            background-color: rgba(15, 23, 42, 0.85); /* Slate-900 with high opacity */
        }

        /* Mobile Sidebar state management */
        .sidebar-visible {
            transform: translateX(0) !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-purple-50 min-h-screen">
    
    <!-- Mobile Menu Toggle -->
    <button id="mobileMenuBtn" class="fixed top-4 left-4 z-50 lg:hidden p-3 glass rounded-xl shadow-lg hover-lift ripple">
        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <div class="flex min-h-screen p-4 gap-4">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:relative inset-y-0 left-0 z-40 w-72 glass-dark rounded-2xl shadow-2xl p-6 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
            
            <!-- Profile Section -->
            <div class="text-center mb-8 fade-in-up">
                <div class="relative inline-block float-animate">
                    <div class="w-20 h-20 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 p-1 pulse-glow">
                        <img class="w-full h-full rounded-full object-cover border-4 border-slate-800" 
                             src="https://i.pinimg.com/736x/f6/cd/2b/f6cd2b2b5a6c35c458138899b8fc6035.jpg" alt="Profile">
                    </div>
                    <div class="absolute bottom-0 right-0 w-5 h-5 bg-green-400 rounded-full border-3 border-slate-800 badge-pulse"></div>
                </div>
                <h3 class="text-xl font-bold text-white mt-4 mb-1">nhoy</h3>
                <p class="text-sm text-slate-400">admin@kh.com</p>
                <div class="mt-3 inline-flex items-center gap-2 px-3 py-1 bg-purple-500/20 rounded-full">
                    <span class="w-2 h-2 bg-green-400 rounded-full badge-pulse"></span>
                    <span class="text-xs text-green-400 font-medium">Online</span>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="space-y-2 mb-8">
                <a href="#" class="flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-300 hover-lift delay-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span class="font-medium">Dashboard</span>
                </a>
                
                <a href="#" class="flex items-center gap-3 px-4 py-3 text-white bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl shadow-lg shine-effect delay-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                    <span class="font-medium">Orders</span>
                    <span id="orderCountBadge" class="ml-auto bg-white/20 px-2 py-1 rounded-full text-xs">...</span>
                </a>
                
                <a href="#" class="flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-300 hover-lift delay-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <span class="font-medium">Customers</span>
                </a>
                
                <a href="#" class="flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-300 hover-lift delay-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="font-medium">Analytics</span>
                </a>
                
                <a href="#" class="flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-300 hover-lift delay-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"></path>
                    </svg>
                    <span class="font-medium">Support</span>
                    <span class="ml-auto bg-red-500 px-2 py-1 rounded-full text-xs badge-pulse">3</span>
                </a>
                
                <a href="#" class="flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-300 hover-lift delay-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="font-medium">Settings</span>
                </a>
            </nav>

            <!-- Logout Button -->
            <div class="mt-auto pt-6 border-t border-slate-700">
                <button class="flex items-center gap-3 w-full px-4 py-3 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-xl transition-all duration-300 hover-lift ripple">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col gap-4">
            
            <!-- Top Bar -->
            <header class="glass rounded-2xl shadow-lg p-4 hover-lift fade-in-up">
                <div class="flex items-center justify-between gap-4 flex-wrap">
                    <div class="flex-1 max-w-2xl min-w-[200px]">
                        <div class="relative">
                            <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input 
                                type="search" 
                                id="searchBar"
                                placeholder="Search orders, users, UDIDs..."
                                class="w-full pl-12 pr-4 py-3 bg-slate-50 border-0 rounded-xl text-sm focus:ring-2 focus:ring-purple-500 focus:bg-white transition-all duration-300"
                                onkeyup="filterTable()"
                            >
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <button class="relative p-3 text-slate-600 hover:text-purple-600 hover:bg-purple-50 rounded-xl transition-all duration-300 hover-lift ripple">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.158 6 8.358 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                            <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full badge-pulse"></span>
                        </button>
                        
                        <div class="w-10 h-10 rounded-xl overflow-hidden hover-lift cursor-pointer border-2 border-purple-500">
                            <img src="https://i.pinimg.com/736x/99/75/3c/99753cfb7de3720c732135e5a70901a7.jpg" alt="Admin" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </header>

            <!-- Stats Cards (AUTO UPDATING) -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                
                <!-- Total Orders Card -->
                <div class="glass rounded-2xl shadow-lg p-6 hover-lift shine-effect fade-in-up delay-100">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-slate-600">Total Orders</h3>
                        <div class="p-2 bg-purple-100 rounded-lg">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                        </div>
                    </div>
                    <!-- Auto-updated by JS -->
                    <p id="statTotalOrders" class="text-3xl font-bold text-slate-800">0</p>
                    <p id="statMonthlyGrowth" class="text-xs text-slate-500 mt-2 flex items-center gap-1">
                        Calculating...
                    </p>
                </div>

                <!-- Completed Card -->
                <div class="glass rounded-2xl shadow-lg p-6 hover-lift shine-effect fade-in-up delay-200">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-slate-600">Completed</h3>
                        <div class="p-2 bg-green-100 rounded-lg">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                    <!-- Auto-updated by JS -->
                    <p id="statCompleted" class="text-3xl font-bold text-slate-800">0</p>
                    <p id="statCompletionRate" class="text-xs text-green-500 mt-2">0% completion rate</p>
                </div>

                <!-- Pending Card -->
                <div class="glass rounded-2xl shadow-lg p-6 hover-lift shine-effect fade-in-up delay-300">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-slate-600">Pending</h3>
                        <div class="p-2 bg-amber-100 rounded-lg">
                            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <!-- Auto-updated by JS -->
                    <p id="statPending" class="text-3xl font-bold text-slate-800">0</p>
                    <p class="text-xs text-amber-500 mt-2">Requires attention</p>
                </div>

                <!-- Revenue Card -->
                <div class="glass rounded-2xl shadow-lg p-6 hover-lift shine-effect fade-in-up delay-400">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-slate-600">Revenue</h3>
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <!-- Auto-updated by JS -->
                    <p id="statRevenue" class="text-3xl font-bold text-slate-800">$0.00</p>
                    <p id="statRevenueGrowth" class="text-xs text-slate-500 mt-2 flex items-center gap-1">
                        Calculating...
                    </p>
                </div>
            </div>

            <!-- Orders Table Section -->
            <div class="glass rounded-2xl shadow-lg overflow-hidden flex-1 flex flex-col fade-in-up">
                <div class="p-6 border-b border-slate-200">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Order Management</h2>
                            <p class="text-sm text-slate-500 mt-1">Track and manage all customer orders</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-3">
                            <input type="date" class="px-4 py-2 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-purple-500 transition-all duration-300">
                            <input type="date" class="px-4 py-2 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-purple-500 transition-all duration-300">
                            <button onclick="fetchOrders()" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-xl hover:shadow-lg transition-all duration-300 hover-lift ripple btn-glow flex items-center gap-2">
                                <svg id="refreshIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span id="refreshText">Refresh</span>
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4 overflow-x-auto pb-2">
                        <button onclick="filterByStatus('all')" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-lg text-sm whitespace-nowrap shine-effect" id="btn-all">All Orders</button>
                        <button onclick="filterByStatus('completed')" class="px-4 py-2 bg-slate-100 text-slate-600 hover:bg-slate-200 font-medium rounded-lg text-sm whitespace-nowrap transition-all duration-300" id="btn-completed">Completed</button>
                        <button onclick="filterByStatus('pending')" class="px-4 py-2 bg-slate-100 text-slate-600 hover:bg-slate-200 font-medium rounded-lg text-sm whitespace-nowrap transition-all duration-300" id="btn-pending">Pending</button>
                        <button onclick="filterByStatus('cancelled')" class="px-4 py-2 bg-slate-100 text-slate-600 hover:bg-slate-200 font-medium rounded-lg text-sm whitespace-nowrap transition-all duration-300" id="btn-cancelled">Cancelled</button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingSpinner" class="flex justify-center items-center p-12 hidden">
                    <div class="relative">
                        <div class="w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-8 h-8 bg-purple-500 rounded-full pulse-glow"></div>
                        </div>
                    </div>
                    <p class="ml-4 text-slate-600 font-medium">Loading orders...</p>
                </div>

                <!-- Table Content (Scrollable on Mobile) -->
                <div class="flex-1 overflow-hidden flex flex-col">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full min-w-[1000px]">
                            <thead class="bg-gradient-to-r from-slate-50 to-slate-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">UDID</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Price</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Link Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orderTableBody" class="divide-y divide-slate-200">
                                <!-- Data injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="p-6 border-t border-slate-200 bg-slate-50">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <p id="paginationInfo" class="text-sm text-slate-600">
                            Showing <span id="startRange" class="font-semibold">0</span> to <span id="endRange" class="font-semibold">0</span> of <span id="totalItems" class="font-semibold">0</span> orders
                        </p>
                        <div class="flex gap-2">
                            <button id="backButton" class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-white transition-all duration-300 hover-lift ripple disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <span id="pageNumberDisplay" class="px-4 py-2 bg-purple-500/10 text-purple-700 font-medium rounded-lg text-sm flex items-center">
                                Page 1
                            </span>
                            <button id="nextButton" class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-white transition-all duration-300 hover-lift ripple">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->

    <!-- Link Input Modal Structure (Edit Link) -->
    <div id="linkModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay-bg">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-xl mx-4 modal-slide-in">
            <h3 id="modalTitle" class="text-2xl font-bold text-slate-800 mb-6 border-b pb-3">Input Link</h3>
            
            <div class="space-y-6">
                <div>
                    <label for="modalLinkInput" class="block text-sm font-semibold text-slate-700 mb-2">1. Main Download Link (File/ZIP/IPA)</label>
                    <input type="url" id="modalLinkInput" placeholder="https://cdn.server.com/main_file.zip"
                           class="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-300">
                    <p class="text-xs text-slate-500 mt-1">This link is used for the file attachment and the main link in the message (required).</p>
                </div>
                
                <div>
                    <label for="modalLinkInput2" class="block text-sm font-semibold text-slate-700 mb-2">2. Secondary Link (Backup/Instructions)</label>
                    <input type="url" id="modalLinkInput2" placeholder="https://backup.drive.com/instructions.html"
                           class="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-300">
                    <p class="text-xs text-slate-500 mt-1">This link will be included as a secondary clickable link in the Telegram message (optional).</p>
                </div>
            </div>
            
            <div class="mt-8 flex justify-end space-x-3">
                <button onclick="closeModal('linkModal')" 
                        class="px-6 py-3 bg-slate-200 text-slate-700 font-medium rounded-xl hover:bg-slate-300 transition duration-150 hover-lift ripple">
                    Cancel
                </button>
                <button id="modalSaveButton"
                        class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-xl hover:shadow-lg transition duration-300 hover-lift ripple btn-glow">
                    Save Links & Update
                </button>
            </div>
        </div>
    </div>

    <!-- View Details Modal Structure -->
    <div id="detailsModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay-bg">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-xl mx-4 modal-slide-in">
            <h3 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-3">Order Details</h3>
            
            <div id="detailsContent" class="space-y-3 text-sm">
                <!-- Details will be injected here -->
            </div>
            
            <div class="mt-8 flex justify-end">
                <button onclick="closeModal('detailsModal')" 
                        class="px-6 py-3 bg-slate-200 text-slate-700 font-medium rounded-xl hover:bg-slate-300 transition duration-150 hover-lift ripple">
                    Close
                </button>
            </div>
        </div>
    </div>


    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000'; 
        const tableBody = document.getElementById('orderTableBody');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const refreshIcon = document.getElementById('refreshIcon');
        const refreshText = document.getElementById('refreshText');
        const sidebar = document.getElementById('sidebar');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const orderCountBadge = document.getElementById('orderCountBadge');

        // Modal elements
        const linkModal = document.getElementById('linkModal');
        const modalLinkInput1 = document.getElementById('modalLinkInput'); // Primary Link
        const modalLinkInput2 = document.getElementById('modalLinkInput2'); // Secondary Link
        const modalTitle = document.getElementById('modalTitle');
        const modalSaveButton = document.getElementById('modalSaveButton');
        const detailsModal = document.getElementById('detailsModal');
        const detailsContent = document.getElementById('detailsContent');
        let currentOrderKey = null; 
        let currentUserId = null; 
        
        // Pagination State
        const ITEMS_PER_PAGE = 10;
        let allOrdersData = [];
        let filteredOrders = [];
        let currentPage = 1;

        // Pagination DOM Elements
        const backButton = document.getElementById('backButton');
        const nextButton = document.getElementById('nextButton');
        const pageNumberDisplay = document.getElementById('pageNumberDisplay');
        const totalItems = document.getElementById('totalItems');
        const startRange = document.getElementById('startRange');
        const endRange = document.getElementById('endRange');

        // --- MOBILE MENU TOGGLE ---
        if(mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('sidebar-visible');
            });
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth < 1024) {
                if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                    sidebar.classList.remove('sidebar-visible');
                }
            }
        });

        // --- MODAL FUNCTIONS ---

        function openModal(modalId, orderKey = null, userId = null, currentLink = null) {
            if (modalId === 'linkModal') {
                currentOrderKey = orderKey;
                currentUserId = userId;
                modalTitle.textContent = `Edit Link for Order ${orderKey.substring(0, 8)}...`;
                
                const order = allOrdersData.find(o => o.order_key === orderKey) || {};
                
                // Primary Link (Used for file attachment)
                const link1 = order.link_primary || order.link || '';
                const isDefault1 = link1.includes('http://yourdomain.com/downloads');
                modalLinkInput1.value = isDefault1 ? '' : link1;
                
                // Secondary Link (New - Used for backup/instructions)
                const link2 = order.link_secondary || '';
                modalLinkInput2.value = link2;
            }
            document.getElementById(modalId).classList.remove('hidden');
            document.body.style.overflow = 'hidden'; 
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // --- CORE FUNCTIONAL HANDLERS ---

        // Attach link modal save logic
        modalSaveButton.onclick = async () => {
            const link1 = modalLinkInput1.value.trim();
            const link2 = modalLinkInput2.value.trim();
            
            if (!link1 || !link1.startsWith('http')) {
                showToast("Error: Primary Link 1 must be a valid http/https link.", 'error');
                return;
            }
            
            modalSaveButton.disabled = true;
            modalSaveButton.textContent = 'Saving...';
            
            // Pass BOTH links
            const success = await saveLink(currentOrderKey, link1, link2); 
            
            modalSaveButton.textContent = 'Save Links & Update';
            modalSaveButton.disabled = false;
            
            if (success) {
                closeModal('linkModal');
            }
        };

        async function deleteOrder(orderKey) {
            if (!confirm(`Are you sure you want to permanently delete order ${orderKey.substring(0, 8)}...? This cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/delete_order/${orderKey}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    showToast(`Order ${orderKey.substring(0, 8)}... successfully deleted.`, 'error');
                    // Remove from local data and re-render
                    allOrdersData = allOrdersData.filter(o => o.order_key !== orderKey);
                    filterTable(); // Re-filter and re-render the current view
                    calculateDashboardStats(allOrdersData); // Update stats
                } else {
                    const errorData = await response.json();
                    showToast(`Failed to delete order: ${errorData.message || 'Server error'}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                showToast('Network error while deleting order. Check server connection.', 'error');
            }
        }

        function viewDetails(orderKey) {
            const order = allOrdersData.find(o => o.order_key === orderKey);
            if (!order) {
                showToast('Order details not found.', 'error');
                return;
            }
            
            const primaryLink = order.link_primary || order.link || 'N/A';
            const secondaryLink = order.link_secondary || 'N/A';
            const isLinkPending = primaryLink.includes('http://yourdomain.com/downloads');
            const completionDate = order.completion_time ? new Date(order.completion_time).toLocaleString() : 'N/A';

            detailsContent.innerHTML = `
                <div class="font-bold text-slate-800 text-xl mb-4 border-b pb-2">Order Summary</div>
                <p class="text-base"><span class="font-medium text-purple-600">User:</span> ${order.username} (ID: ${order.user_id})</p>
                <p class="text-base"><span class="font-medium text-purple-600">Order Key:</span> <code class="bg-slate-100 p-1 rounded text-xs">${order.order_key}</code></p>
                <p class="text-base"><span class="font-medium text-purple-600">UDID:</span> <code class="bg-slate-100 p-1 rounded">${order.udid}</code></p>
                <p class="text-base"><span class="font-medium text-purple-600">Plan/Price:</span> <span class="font-semibold">$${order.payment_option}</span></p>
                <p class="text-base"><span class="font-medium text-purple-600">Submitted:</span> ${new Date(order.save_time).toLocaleString()}</p>
                <p class="text-base"><span class="font-medium text-purple-600">Completed:</span> ${completionDate}</p>
                <p class="text-base"><span class="font-medium text-purple-600">Link Status:</span> <span class="${isLinkPending ? 'text-red-500' : 'text-green-500'} font-semibold">${isLinkPending ? 'PENDING ADMIN LINK' : 'READY TO SEND'}</span></p>
                
                <div class="mt-4 pt-3 border-t border-slate-200">
                    <p class="text-base break-words"><span class="font-medium text-purple-600">1. Main Link (File):</span> <a href="${primaryLink}" target="_blank" class="text-blue-500 hover:underline">${primaryLink}</a></p>
                    <p class="text-base break-words"><span class="font-medium text-purple-600">2. Secondary Link:</span> <a href="${secondaryLink}" target="_blank" class="text-blue-500 hover:underline">${secondaryLink}</a></p>
                </div>
            `;

            openModal('detailsModal');
        }

        async function saveLink(orderKey, linkToSave1, linkToSave2) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/update_link/${orderKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        link1: linkToSave1, 
                        link2: linkToSave2 
                    }),
                });

                if (response.ok) {
                    showToast(`Links saved successfully for order ${orderKey.substring(0, 4)}...`, 'success');
                    // Update local data array
                    const index = allOrdersData.findIndex(o => o.order_key === orderKey);
                    if (index !== -1) {
                        allOrdersData[index].link = linkToSave1; 
                        allOrdersData[index].link_primary = linkToSave1; 
                        allOrdersData[index].link_secondary = linkToSave2; 
                        filterTable(); 
                        calculateDashboardStats(allOrdersData); // Refresh stats
                    }
                    return true;
                } else {
                    const errorData = await response.json();
                    showToast(`Failed to save links: ${errorData.message || 'Server error'}`, 'error');
                    return false;
                }

            } catch (error) {
                console.error('Error updating link:', error);
                showToast('Network error while saving link. Check Flask server connection.', 'error');
                return false;
            }
        }
        
        async function sendLinkToUser(userId, orderKey) {
            const order = allOrdersData.find(o => o.order_key === orderKey);
            const primaryLink = order.link_primary || order.link || null;
            const secondaryLink = order.link_secondary || '';
            
            if (!primaryLink || primaryLink.includes('http://yourdomain.com/downloads')) {
                showToast("Error: Please input and save the final Primary Link before sending.", 'error');
                return;
            }
            
            if (!confirm(`Confirm sending the final link(s) to User ID ${userId}?`)) {
                return;
            }
            
            const button = document.getElementById(`sendButton-${orderKey}`);
            const originalText = 'Send Link ðŸ”—';

            button.disabled = true;
            button.textContent = 'Sending...';

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/send_link`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: userId, 
                        link_primary: primaryLink, 
                        link_secondary: secondaryLink
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`âœ… Success: ${data.message}`, 'success');
                } else {
                    showToast(`âŒ Failed to Send: ${data.message}`, 'error');
                }

            } catch (error) {
                console.error('Error sending link via API:', error);
                showToast('Network error while attempting to send link.', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // --- STATS CALCULATION LOGIC ---
        function calculateDashboardStats(orders) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // 1. Initialize Counters
            let totalOrders = orders.length;
            let completedOrders = 0;
            let pendingOrders = 0;
            let totalRevenue = 0;

            // Monthly Growth Logic
            let thisMonthOrders = 0;
            let lastMonthOrders = 0;
            let thisMonthRevenue = 0;
            let lastMonthRevenue = 0;

            orders.forEach(order => {
                // Parse Price
                const price = parseFloat(order.payment_option) || 0;
                totalRevenue += price;

                // Check Status (Completed vs Pending)
                // Logic: If link contains default domain OR is empty = Pending. Else = Completed.
                const isDefaultLink = !order.link || order.link.includes('http://yourdomain.com/downloads');
                
                if (isDefaultLink) {
                    pendingOrders++;
                } else {
                    completedOrders++;
                }

                // Date Logic for Growth Calculation
                if (order.save_time) {
                    const orderDate = new Date(order.save_time);
                    const orderMonth = orderDate.getMonth();
                    const orderYear = orderDate.getFullYear();

                    // Check This Month
                    if (orderMonth === currentMonth && orderYear === currentYear) {
                        thisMonthOrders++;
                        thisMonthRevenue += price;
                    }
                    
                    // Check Last Month
                    const prevDate = new Date();
                    prevDate.setMonth(currentMonth - 1);
                    
                    if (orderMonth === prevDate.getMonth() && orderYear === prevDate.getFullYear()) {
                        lastMonthOrders++;
                        lastMonthRevenue += price;
                    }
                }
            });

            // 2. Calculate Percentages
            const completionRate = totalOrders > 0 ? Math.round((completedOrders / totalOrders) * 100) : 0;
            
            // Order Growth Rate
            let orderGrowthHtml = '<span class="text-slate-400">No data for comparison</span>';
            if (lastMonthOrders > 0) {
                const growth = ((thisMonthOrders - lastMonthOrders) / lastMonthOrders) * 100;
                const isPositive = growth >= 0;
                const colorClass = isPositive ? 'text-green-500' : 'text-red-500';
                const icon = isPositive 
                    ? '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>'
                    : '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>';
                
                orderGrowthHtml = `<span class="${colorClass} flex items-center gap-1">${icon} ${Math.abs(Math.round(growth))}% from last month</span>`;
            } else if (thisMonthOrders > 0) {
                 orderGrowthHtml = `<span class="text-green-500 flex items-center gap-1">New orders this month!</span>`;
            }

            // Revenue Growth Rate
            let revenueGrowthHtml = '<span class="text-slate-400">No data for comparison</span>';
            if (lastMonthRevenue > 0) {
                const revGrowth = ((thisMonthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100;
                const isPos = revGrowth >= 0;
                const color = isPos ? 'text-green-500' : 'text-red-500';
                 const icon = isPos 
                    ? '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>'
                    : '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>';
                
                revenueGrowthHtml = `<span class="${color} flex items-center gap-1">${icon} ${Math.abs(Math.round(revGrowth))}% from last month</span>`;
            }

            // 3. Update DOM Elements with Animation
            animateValue("statTotalOrders", 0, totalOrders, 1000);
            animateValue("statCompleted", 0, completedOrders, 1000);
            animateValue("statPending", 0, pendingOrders, 1000);
            
            // For Revenue (Text only, no number animation for simplicity with formatting)
            document.getElementById("statRevenue").textContent = `$${totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            document.getElementById("statCompletionRate").textContent = `${completionRate}% completion rate`;
            document.getElementById("statMonthlyGrowth").innerHTML = orderGrowthHtml;
            document.getElementById("statRevenueGrowth").innerHTML = revenueGrowthHtml;
        }

        // Helper function for smooth number counting animation
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if (!obj) return;
            
            if (start === end) {
                 obj.textContent = end;
                 return;
            }
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            
            const timer = setInterval(function() {
                current += increment;
                obj.textContent = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, Math.max(stepTime, 20)); // Cap speed at 20ms
            
            // Immediate set if number is huge to avoid long delay
            if(Math.abs(range) > 100) {
                 clearInterval(timer);
                 obj.textContent = end;
            }
        }

        // --- DATA FILTERING AND RENDERING ---

        function filterTable() {
            const searchTerm = document.getElementById('searchBar').value.toLowerCase();
            
            filteredOrders = allOrdersData.filter(order => {
                const user = order.username ? order.username.toLowerCase() : '';
                const udid = order.udid ? order.udid.toLowerCase() : '';
                const price = order.payment_option ? order.payment_option.toString() : '';
                
                return user.includes(searchTerm) || udid.includes(searchTerm) || price.includes(searchTerm);
            });
            
            currentPage = 1;
            renderTableData(filteredOrders);
        }
        
        function filterByStatus(status) {
            const originalSearch = document.getElementById('searchBar').value;
            document.getElementById('searchBar').value = ''; 
            
            if (status === 'all') {
                filteredOrders = allOrdersData;
            } else if (status === 'completed') {
                 filteredOrders = allOrdersData.filter(o => o.completion_time && !o.link.includes('http://yourdomain.com/downloads'));
            } else if (status === 'pending') {
                filteredOrders = allOrdersData.filter(o => o.link.includes('http://yourdomain.com/downloads'));
            } else if (status === 'cancelled') {
                 filteredOrders = allOrdersData.filter(o => o.payment_option === '4'); 
            }
            
            if (originalSearch) {
                document.getElementById('searchBar').value = originalSearch;
                filterTable();
                return;
            }

            ['all', 'completed', 'pending', 'cancelled'].forEach(s => {
                const btn = document.getElementById(`btn-${s}`);
                if (!btn) return;

                if (s === status) {
                    btn.className = 'px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-lg text-sm whitespace-nowrap shine-effect';
                } else {
                    btn.className = 'px-4 py-2 bg-slate-100 text-slate-600 hover:bg-slate-200 font-medium rounded-lg text-sm whitespace-nowrap transition-all duration-300';
                }
            });
            
            currentPage = 1;
            renderTableData(filteredOrders);
        }

        function renderTableData(orders) {
            const tbody = document.getElementById('orderTableBody');
            tbody.innerHTML = '';
            
            const totalItemsCount = orders.length;
            const totalPages = Math.ceil(totalItemsCount / ITEMS_PER_PAGE);

            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = currentPage * ITEMS_PER_PAGE;
            const paginatedOrders = orders.slice(start, end);

            paginatedOrders.forEach((order, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition-all duration-300 fade-in-up';
                row.style.animationDelay = `${index * 0.05}s`;
                
                const currentPrimaryLink = order.link_primary || order.link;
                const isDefaultLink = !currentPrimaryLink || currentPrimaryLink.includes('http://yourdomain.com/downloads');
                const linkStatusText = isDefaultLink ? 'Pending Link' : 'Link Active';
                
                const linkButtonClass = isDefaultLink 
                    ? 'bg-red-500/80 hover:bg-red-600' 
                    : 'bg-gradient-to-r from-purple-500 to-pink-500 shadow-md btn-glow hover:shadow-lg'; 

                const sendButtonColor = isDefaultLink 
                    ? 'bg-amber-500/80 hover:bg-amber-600' 
                    : 'bg-gradient-to-r from-green-500 to-emerald-600 shadow-md btn-glow hover:shadow-lg'; 

                const completionStatus = order.completion_time ? 'Completed' : 'In Progress';
                const completionBadgeClass = order.completion_time ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700';

                const completionDate = order.completion_time ? new Date(order.completion_time).toLocaleString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
                }) : 'N/A';

                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 flex items-center justify-center text-white font-semibold shadow-lg">
                                ${order.username ? order.username[0].toUpperCase() : 'U'}
                            </div>
                            <div>
                                <p class="font-medium text-slate-800">${order.username}</p>
                                <p class="text-xs text-slate-500">ID: ${order.user_id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <code class="text-xs bg-slate-100 px-3 py-2 rounded-lg font-mono text-slate-700 hover:bg-slate-200 transition-all duration-300">${order.udid}</code>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-lg font-bold text-slate-800">$${order.payment_option}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium ${completionBadgeClass} badge-pulse">
                            ${completionStatus}
                        </span>
                        <p class="text-xs text-slate-500 mt-1">${completionDate}</p>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-700">
                            ${linkStatusText}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <!-- Input/Edit Link Button -->
                            <button 
                                id="linkInputButton-${order.order_key}"
                                onclick="openModal('linkModal', '${order.order_key}', ${order.user_id}, '${currentPrimaryLink}')"
                                data-currentlink="${currentPrimaryLink}"
                                class="px-3 py-2 text-xs font-medium text-white rounded-lg transition-all duration-300 hover-lift ${linkButtonClass} btn-glow"
                            >
                                ${isDefaultLink ? 'Input Link âŒ' : 'Edit Link âœ…'}
                            </button>
                            
                            <!-- Send Link Button -->
                            <button 
                                id="sendButton-${order.order_key}"
                                onclick="sendLinkToUser(${order.user_id}, '${order.order_key}')"
                                class="p-2 text-white rounded-lg transition-all duration-300 hover-lift ripple ${sendButtonColor}"
                                title="Send Link/File to User"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>

                            <!-- View Details Button -->
                            <button onclick="viewDetails('${order.order_key}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-300 hover-lift ripple" title="View Details">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>

                            <!-- Delete Button -->
                            <button onclick="deleteOrder('${order.order_key}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-all duration-300 hover-lift ripple" title="Delete Order">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            updatePaginationControls(totalItemsCount, totalPages);
        }

        // --- PAGINATION CONTROL LOGIC ---

        nextButton.addEventListener('click', () => {
            if (currentPage * ITEMS_PER_PAGE < filteredOrders.length) {
                currentPage++;
                renderTableData(filteredOrders);
            }
        });

        backButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTableData(filteredOrders);
            }
        });
        
        function updatePaginationControls(totalItemsCount, totalPages) {
            const startItem = totalItemsCount > 0 ? (currentPage - 1) * ITEMS_PER_PAGE + 1 : 0;
            const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItemsCount);
            
            pageNumberDisplay.textContent = `Page ${currentPage} of ${totalPages}`;
            totalItems.textContent = totalItemsCount;
            startRange.textContent = startItem;
            endRange.textContent = endItem;

            backButton.disabled = (currentPage === 1);
            nextButton.disabled = (currentPage === totalPages) || (totalItemsCount <= ITEMS_PER_PAGE);
        }

        // --- DATA FETCHING ---

        async function fetchOrders() {
            tableBody.innerHTML = '';
            loadingSpinner.classList.remove('hidden');
            refreshText.textContent = 'Loading...';
            refreshIcon.classList.add('rotate-animate');

            try {
                const response = await fetch(`${API_BASE_URL}/admin/orders`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Convert object of objects into an array of values
                allOrdersData = Object.values(data).sort((a, b) => new Date(b.completion_time) - new Date(a.completion_time)); 
                filteredOrders = allOrdersData;
                
                // Update badge count
                orderCountBadge.textContent = allOrdersData.length;

                // --- UPDATE DASHBOARD STATS ---
                calculateDashboardStats(allOrdersData);
                // ------------------------------

                // Initial render
                currentPage = 1;
                renderTableData(filteredOrders);

                if (allOrdersData.length === 0) {
                     document.getElementById('paginationInfo').classList.add('hidden');
                } else {
                     document.getElementById('paginationInfo').classList.remove('hidden');
                }
                
                showToast('Orders refreshed successfully!', 'success');

            } catch (error) {
                console.error('Error fetching orders:', error);
                tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">
                    Failed to connect to backend API at ${API_BASE_URL}. Check if app.py is running.
                </td></tr>`;
                showToast('Failed to load data. Check console.', 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
                refreshText.textContent = 'Refresh';
                refreshIcon.classList.remove('rotate-animate');
            }
        }
        
        function showToast(message, type = 'success') {
            const colors = {
                success: 'from-green-500 to-emerald-500',
                error: 'from-red-500 to-rose-500',
                info: 'from-blue-500 to-cyan-500'
            };
            
            const icons = {
                success: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                error: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                info: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            };
            
            const toast = document.createElement('div');
            toast.className = `fixed bottom-8 right-8 bg-gradient-to-r ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl z-50 modal-slide-in flex items-center gap-3`;
            toast.innerHTML = `
                ${icons[type]}
                <span class="font-medium">${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchOrders();
        });
    </script>
</body>
</html>